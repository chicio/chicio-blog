
<!--
AI Agent Instructions for chicio-blog
-->

# chicio-blog: AI Agent Coding Guide

This project is a Next.js (App Router) blog with a Matrix-inspired UI, using React, TailwindCSS, and Framer Motion. The codebase is modular, atomic, and highly type-safe. Follow these conventions and workflows for maximum productivity:

## Architecture & Structure

- **Atomic Design System**: UI is built from atoms, molecules, organisms, templates in [`src/components/design-system`](src/components/design-system). Compose new UI from these layers.
- **Section Isolation**: Each main feature (blog, chat, art, etc.) lives in `src/components/sections/<section>`, with its own `components/` and `hooks/`.
- **Business Logic**: All core logic/utilities are in [`src/lib`](src/lib) (e.g., post parsing, search, tracking, motion, local storage).
- **Types**: All shared types are in [`src/types`](src/types). Update these when changing data models or tracked events.
- **Content**: 
  - Blog posts are Markdown (`.md`) files in [`src/content/posts`](src/content/posts) with frontmatter
  - DSA content in [`src/content/dsa`](src/content/dsa) uses MDX (`.mdx`) for interactive components
  - Parsing handled by `gray-matter` and custom logic in [`src/lib/posts`](src/lib/posts)
  - MDX components defined in [`src/mdx-components.tsx`](src/mdx-components.tsx)

## Developer Workflows

- **Install**: `npm install`
- **Dev server**: `npm run dev` (auto-generates search index)
- **Build**: `npm run build` (auto-generates search index)
- **Release**: `npm run release` (uses `release-it`, config in [`.release-it.json`](.release-it.json))
- **Lint**: `npm run lint` (ESLint, config in [`eslint.config.mjs`](eslint.config.mjs))
- **Search Index**: Generated by `npm run search-index` (runs `tsx src/lib/posts/search.ts` to create [`public/search-index.json`](public/search-index.json))
- **Chat Knowledge Upload**: `npm run chat-knowledge-upload` (uploads blog content to Upstash Vector for RAG)
- **CI/CD**: See [`.github/workflows/build.yml`](.github/workflows/build.yml) (runs on macOS, caches npm, builds with Upstash Vector secrets)

## Project Conventions

- **Glassmorphism & Motion**: Use `useGlassmorphism` and `useMotionSettings` for UI effects. Motion settings are stored in localStorage with a `fabrizioduroni_` prefix.
- **Tracking**: All navigation and UI actions are tracked via Google Analytics (gated by cookie consent). Use `trackWith` helper and update [`src/types/tracking.ts`](src/types/tracking.ts) for new events.
- **Menu & Navigation**: Main menu is in [`src/components/design-system/organism/menu.tsx`](src/components/design-system/organism/menu.tsx) (uses `MenuItemWithTracking`). Add new sections in [`src/types/slug.ts`](src/types/slug.ts) and register in the menu.
- **Chat**: 
  - Uses `@ai-sdk/groq` (Llama 3.3 70B) and `@ai-sdk/react` for AI chat functionality
  - Chat UI is in [`src/components/sections/chat/components`](src/components/sections/chat/components)
  - Chat state management in [`src/components/sections/chat/hooks/useFabrizioChat.ts`](src/components/sections/chat/hooks/useFabrizioChat.ts)
  - LLM system prompt configuration in [`src/lib/chat/llm-prompt.ts`](src/lib/chat/llm-prompt.ts)
  - RAG (Retrieval Augmented Generation) using Upstash Vector in [`src/lib/chat/upstash-vector.ts`](src/lib/chat/upstash-vector.ts)
  - Chat API endpoint at [`src/app/api/chat/route.ts`](src/app/api/chat/route.ts)
- **Search**: Powered by `elasticlunr`, index built from Markdown frontmatter and stored in [`public/search-index.json`](public/search-index.json).
- **Easter Eggs**: Special features (Matrix rain, white rabbit, etc.) are in [`src/components/sections/easter-eggs`](src/components/sections/easter-eggs).

## Integration & External Dependencies

- **Next.js**: App Router in [`src/app`](src/app). Update routes/layouts here. Currently using Next.js 15.0.3.
- **TailwindCSS**: Utility-first styling, config in [`tailwind.config.mjs`](tailwind.config.mjs). Uses @tailwindcss/postcss v4.
- **Framer Motion**: For all UI animations (v12.0.0-alpha.1).
- **Markdown & MDX Rendering**: 
  - Uses `remark`, `rehype`, `katex`, and plugins for math, emoji, GFM, syntax highlighting
  - MDX support via `@next/mdx` for interactive content with React components
  - Custom MDX components mapped in [`src/mdx-components.tsx`](src/mdx-components.tsx)
- **Upstash Vector**: Used for RAG in chat feature (requires `UPSTASH_VECTOR_REST_URL` and `UPSTASH_VECTOR_REST_TOKEN` env vars).
- **Groq AI**: LLM provider for chat feature using Llama 3.3 70B model.
- **Analytics**: 
  - Google Analytics via `@next/third-parties`
  - Vercel Analytics and Speed Insights
- **React**: Version 19.0.0-rc-66855b96-20241106 (React and React DOM).

## Code Style & Quality

- **Indentation**: 4 spaces (not tabs)
- **Line length**: 120 characters max
- **Prettier**: Config in [`.prettierrc`](.prettierrc) with Tailwind plugin
- **ESLint**: Extends Next.js core-web-vitals and TypeScript configs
- **TypeScript**: Strict mode enabled, config in [`tsconfig.json`](tsconfig.json)
- **Author attribution**: Add author name to new files

## File Organization

- **Content**: 
  - Blog posts in [`src/content/posts`](src/content/posts) (Markdown `.md` with frontmatter)
  - DSA content in [`src/content/dsa`](src/content/dsa) (MDX `.mdx` for interactive components)
- **Public assets**: [`public/`](public/) for static files, images, icons
- **Brand assets**: [`brand/`](brand/) for logos, featured images
- **Environment**: 
  - [`.env.development`](.env.development) for development
  - [`.env.production`](.env.production) for production
- **Node version**: 22.x (specified in [`package.json`](package.json))

## Examples

- **Add blog post**: Place Markdown in [`src/content/posts`](src/content/posts) with frontmatter (date, title, description, tags, authors, image). Search index updates on next build/dev. Reference existing posts for format.
- **Add section**: Create `src/components/sections/<name>`, add `components/` and `hooks/` as needed. Register in menu and [`src/types/slug.ts`](src/types/slug.ts).
- **Extend design system**: Add to [`src/components/design-system/atoms`](src/components/design-system/atoms), compose in molecules/organisms/templates.
- **Tracked navigation**: Use `MenuItemWithTracking` from [`src/components/design-system/organism/menu.tsx`](src/components/design-system/organism/menu.tsx), update [`src/types/tracking.ts`](src/types/tracking.ts) for new actions.
- **Update chat personality**: Edit system prompt in [`src/lib/chat/llm-prompt.ts`](src/lib/chat/llm-prompt.ts), including profile, jokes, and RAG instructions.
- **Add project**: Update [`src/types/projects.ts`](src/types/projects.ts) with new project details, features, and call-to-actions.

## Release Process

- Uses `release-it` with conventional changelog plugin
- Generates [`CHANGELOG.md`](CHANGELOG.md) automatically
- Follows conventional commits (see [`.vscode/settings.json`](.vscode/settings.json) for scopes: performance, ux, capabilities, content)
- GitHub releases created automatically

## Community & Contribution

- **Code of Conduct**: [`CODE_OF_CONDUCT.md`](CODE_OF_CONDUCT.md)
- **Contributing Guide**: [`CONTRIBUTING.md`](CONTRIBUTING.md)
- **PR Template**: [`PULL_REQUEST_TEMPLATE.md`](PULL_REQUEST_TEMPLATE.md)
- **Issue Templates**: [`.github/ISSUE_TEMPLATE/`](.github/ISSUE_TEMPLATE/)
- **Security Policy**: [`SECURITY.md`](SECURITY.md)

## AI Agent Worktree

**IMPORTANT**: When asked to implement any feature or code change, always work in the `agent/` git worktree, NOT in the main workspace root. The `agent/` worktree runs on a dedicated branch and port, keeping work-in-progress isolated from the production branch.

### Working on a feature

1. All file edits go to `agent/` paths (e.g. `agent/src/...`)
2. Start the dev server from the worktree:
   ```bash
   cd agent && npm run dev -- -p 3001
   ```
   The app runs at http://localhost:3001
3. To keep the `agent` branch up to date with `main`:
   ```bash
   cd agent && git rebase main
   ```

### Recreating the worktree from scratch

If the `agent/` worktree is deleted, recreate it with these steps:

```bash
# 1. Create the worktree on the agent branch
git worktree add agent agent

# 2. Install dependencies
cd agent && npm install

# 3. Apply the local-only next.config.ts patch (adds turbopack.root to avoid
#    lock conflicts with the parent workspace when running on a separate port)
cd agent
cat >> /dev/null <<'PATCH'
Add to next.config.ts inside nextConfig, before the `images` key:

  turbopack: {
    root: path.join(__dirname, '..'),
  },

Also add at the top: import path from "path";
PATCH

# 4. Mark the file as skip-worktree so the local patch is never committed
git update-index --skip-worktree next.config.ts
```

The exact diff to apply to `next.config.ts` (local only, never commit):
```typescript
import path from "path"; // add this import

// inside nextConfig:
turbopack: {
    root: path.join(__dirname, '..'),
},
```

> To temporarily commit a legitimate change to `next.config.ts`:
> ```bash
> git update-index --no-skip-worktree next.config.ts
> # stage & commit your change
> git update-index --skip-worktree next.config.ts
> ```

---
For more, see [`README.md`](README.md), [`src/types`](src/types), and [`src/lib`](src/lib). Keep this file up to date with new patterns or workflows.